<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Be Newsletters - Volume 4: 1999</title><link rel="stylesheet" href="be_newsletter.css" type="text/css" media="all" /><link rel="shortcut icon" type="image/vnd.microsoft.icon" href="./images/favicon.ico" /><!--[if IE]>
    <link rel="stylesheet" type="text/css" href="be_newsletter_ie.css" />
    <![endif]--><meta name="generator" content="DocBook XSL Stylesheets V1.73.2" /><link rel="start" href="index.html" title="Be Newsletters" /><link rel="up" href="volume4.html" title="Volume 4: 1999" /><link rel="prev" href="Issue4-13.html" title="Issue 4-13, March 31, 1999" /><link rel="next" href="Issue4-15.html" title="Issue 4-15, April 14, 1999" /></head><body><div id="header"><div id="headerT"><div id="headerTL"><a accesskey="p" href="Issue4-13.html" title="Issue 4-13, March 31, 1999"><img src="./images/navigation/prev.png" alt="Prev" /></a> <a accesskey="u" href="volume4.html" title="Volume 4: 1999"><img src="./images/navigation/up.png" alt="Up" /></a> <a accesskey="n" href="Issue4-15.html" title="Issue 4-15, April 14, 1999"><img src="./images/navigation/next.png" alt="Next" /></a></div><div id="headerTR"><div id="navigpeople"><a href="http://www.haiku-os.org"><img src="./images/People_24.png" alt="haiku-os.org" title="Visit The Haiku Website" /></a></div><div class="navighome" title="Home"><a accesskey="h" href="index.html"><img src="./images/navigation/home.png" alt="Home" /></a></div><div class="navigboxed" id="naviglang" title="English">en</div></div><div id="headerTC">Be Newsletters - Volume 4: 1999</div></div><div id="headerB">Prev: <a href="Issue4-13.html">Issue 4-13, March 31, 1999</a>  Up: <a href="volume4.html">Volume 4: 1999</a>  Next: <a href="Issue4-15.html">Issue 4-15, April 14, 1999</a></div><hr /></div><div class="article"><div xmlns="" xmlns:d="http://docbook.org/ns/docbook" class="titlepage"><div><div xmlns:d="http://docbook.org/ns/docbook"><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="Issue4-14"></a>Issue 4-14, April 7, 1999</h2></div></div></div><div class="sect1"><div xmlns="" xmlns:d="http://docbook.org/ns/docbook" class="titlepage"><div><div xmlns:d="http://docbook.org/ns/docbook"><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="Engineering4-14"></a>Be Engineering Insights: And Now, Live From Be...</h2></div><div xmlns:d="http://docbook.org/ns/docbook"><span xmlns="http://www.w3.org/1999/xhtml" class="author">By <span class="firstname">Steve</span> <span class="surname">Sakoman</span></span></div></div></div><p>
My last Newsletter article,
"<a class="xref" href="Issue3-38.html#Engineering3-38" title="Be Engineering Insights: While You're Waiting For R4...">Be Engineering Insights: While You're Waiting For R4...</a>" seems to
have spawned one of the more peculiar diversions in the Be culture. I'm
referring to the CodyCam application, and its namesake web page:
http://www.sakoman.com/codycam/
</p><p>
For those who are new to BeOS, a brief explanation. CodyCam is a simple
BeOS webcam application; the CodyCam web page demonstrates its
capabilities by uploading pictures of the Be lunchroom at 5-minute
intervals. The program is named for my 14-year-old son, Cody, who
pestered me mercilessly to help him write shell scripts to implement the
initial version of the webcam.
</p><p>
Our lunchroom webcam runs on a funky old Pentium 100 machine. The case
cover disappeared long ago, and the monitor's focus is so bad that it's
practically unusable. We installed a Hauppauge video capture card and
video camera on this humble machine and it faithfully records our
lunchroom comings and goings.
</p><p>
It seems that these simple images have attracted quite an audience. One
viewer produced an mpeg movie of a single 24-hour period. When the
5-minute interval images are played back at 30 frames per second, the
frenetic pace of activity actually resembles what it feels like working
at Be.
</p><p>
In addition to providing glimpses of our lunch gatherings, engineering
staff meetings, and the occasional napping engineer, the webcam has also
turned out to be a means of "communication" to the outside world. Regular
viewers became well-acquainted with our infamous $10 couches, and were
also treated to various topical "scenes in miniature" when engineers
needed another outlet of expression than writing code. They worked with
the materials at hand: Legos, bits of paper, Christmas decorations, bunny
people...
</p><p>
About a month ago we decided to upgrade the lunchroom carpeting and
couches. (To see why, take a look at
http://www.sakoman.com/images/couches.jpg.) A few of our engineers had
some fun replacing the usual CodyCam images with a series of specially
constructed images hinting at some sort of conspiracy. We enjoyed reading
the conspiracy theories during the days that the work was being done --
and we were amazed at the number of offers we had from people who wanted
to buy the old couches and carpeting!
</p><p>
This week there's a new version of CodyCam. You can get the application
and its source code at http://www.sakoman.com/codycam.html
</p><p>
This version of the application uses the BeOS Media Kit. There's far too
much code to discuss in detail here, but the basic structure is quite
simple. After building a traditional UI window containing a menu bar and
settings widgets for configuring the image capture and ftp parameters,
the app builds a Media Kit network consisting of two nodes:
</p><div class="orderedlist"><ol><li><p>
A video capture producer node (we use the system default video
input).
</p></li><li><p>
An app-instantiated consumer node. This node displays the incoming
video stream to a BView and at regular intervals saves a frame to disk
using the Translation Kit. The saved image is then uploaded to a web
server using ftp protocols.
</p></li></ol></div><p>
As is often the case, much of the code in CodyCam is "leveraged" from the
work of others. The video consumer node uses a more recent version of the
<code class="classname">BTimedEventQueue</code> class introduced in Stephen B.'s Newsletter article a
couple of weeks ago,
</p><p>
<a class="xref" href="Issue4-11.html#DevWorkshop4-11" title="Developers' Workshop: Simplifying Media Nodes">Developers' Workshop: Simplifying Media Nodes</a>
</p><p>
The ftp functions are performed using Howard Berkey's wonderful network
libraries. App preferences are saved and restored using Pavel Cisler's
settings classes.
</p></div><hr class="pagebreak" /><div class="sect1"><div xmlns="" xmlns:d="http://docbook.org/ns/docbook" class="titlepage"><div><div xmlns:d="http://docbook.org/ns/docbook"><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="Engineering4-14-2"></a>Be Engineering Insights: Tips and Tricks for Writing High Performance
OpenGL Programs</h2></div><div xmlns:d="http://docbook.org/ns/docbook"><span xmlns="http://www.w3.org/1999/xhtml" class="author">By <span class="firstname">R. Jason</span> <span class="surname">Sams</span></span></div></div></div><p>
Whenever someone asks me, "How do I make this program faster?" I respond
by asking two more questions: "Are you using hardware acceleration?" and
"What is your bottleneck?" If the answer to the first question is "no,"
the usual reply is that you need to spend $50 for a hardware accelerator.
There's no way to achieve acceptable frame rates of 30fps with software
rendering if you're texturing or using a window larger than about 320x200
pixels. The cost of an accelerator no longer justifies the effort it
takes to get usable performance.
</p><p>
If you're using hardware rendering you have a foundation for fast
rendering. Three primary factors affect rendering performance. The first
and most common in today's application is the fill requirement; the
second is the geometry requirement; and the third is the number of state
changes the rendering engine must undergo.
</p><p>
The number of pixels that the rendering engine must draw determines fill
requirements. A single large quad that covers the entire screen at
640x480 pixels would require processing 307,200 fragments. Notice the use
of the word "fragment" and not "pixel." A fragment is internal data that
corresponds to a pixel on the screen. It can be modified several times or
completely discarded before being written to the screen as a pixel.
</p><p>
Some hardware can process fragments faster if they are not written to the
screen. This can happen if a depth test, a stencil test, or an alpha test
fails, among other reasons. Smaller primitives require less processing. A
10x10 quad would require processing only 100 fragments. Modern hardware
can typically process 90 to 180 million fragments per second. By
contrast, software rendering is good for around 1 to 2 million fragments
per second.
</p><p>
The number of vertices and primitives that make up the scene being drawn
determine the geometry requirements. Each primitive that is drawn
requires several processing steps. A typical triangle would go through
transformation, clipping, projection, assembly, culling, and on to the
rasterizer. If advanced modes such as texture-coordinate generation or
lighting are enabled, more steps are needed. The per vertex calculations
normally take the most processing time, with data transfer to the
rasterizer coming in second.
</p><p>
Let's look at some of the requirements for different primitive types. The
table below shows the processing required to draw 10 triangles:
</p><div class="informaltable"><table border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th>Type</th><th>Vertexes needed</th><th>Culling operations</th></tr></thead><tbody><tr><td>Triangles</td><td>30</td><td>10</td></tr><tr><td>Quads</td><td>20</td><td>5</td></tr><tr><td>Triangle Fan</td><td>12</td><td>10</td></tr><tr><td>Triangle Strip</td><td>12</td><td>10</td></tr><tr><td>Quad Strip</td><td>12</td><td>5</td></tr></tbody></table></div><p>
It's clear from the above that you'd want to use Quad Strips wherever
possible. In general, the cost of the culling operation is cheap enough
that you don't see much difference between Quad Strips and Triangle
Strips or Triangle Fans. You can expect to achieve around 1.5 million
triangles drawn per second on a fast PII using Strips or Fans. Other
primitives will be slower. If some of the primitives are being clipped or
culled that value should increase.
</p><p>
Note: Do not expect to achieve anywhere near the manufacturer's claim for
your video card. While the chip could theoretically process between 5 and
9 million triangles per second, the <acronym class="acronym">CPU</acronym> can't process this many. Even if
it could, the <acronym class="acronym">PCI</acronym> or <acronym class="acronym">AGP</acronym> bus couldn't get that many to the video card.
</p><p>
State changes are the hardest to quantify. The best advice is to avoid
them. Say that you have a scene with 500 objects that use 50 different
textures. In most cases it will be faster to sort the objects by texture
and then draw them, than to draw them in an arbitrary order and change
textures as needed. This applies to most state change requirements. The
cost of changing state, compared to the cost of drawing, will become more
expensive in the future. So even if you see little benefit now, you can
expect to see gains in the future.
</p><p>
To find out which of the above is causing you problems, here are a few
things to try:
</p><div class="orderedlist"><ol><li><p>
Resize the window. If the frame rate changes, you're at least
partially fill-rate bound. Look for places in your code where you can
reduce overdraw. (Overdraw is the act of drawing the same pixel more
than once.) Generally, do your best to eliminate occluded objects.
(Objects that are in the field of view but not seen because they're
behind another opaque object.)
</p></li><li><p>
Try reducing the number of state changes. One way to do this is to
temporarily comment out state changes that only affect the appearance
of the scene. Try the texture change commands. This will make your
scene look very strange, but will let you know if that's the problem.
</p></li><li><p>
Try replacing some of the more geometrically complex objects with
simpler ones. If reducing the triangle count while maintaining the
same size objects improves performance, you are geometry bound. You
may want to look at multiple levels of detail for your objects. This
is the process of drawing far away objects with fewer triangles than
objects that are close.
</p></li></ol></div><p>
I hope this is has been helpful. We look forward to seeing those killer
3D apps.
</p></div><hr class="pagebreak" /><div class="sect1"><div xmlns="" xmlns:d="http://docbook.org/ns/docbook" class="titlepage"><div><div xmlns:d="http://docbook.org/ns/docbook"><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="DevWorkshop4-14"></a>Developers' Workshop: The Quest for the Fountain of Audio</h2></div><div xmlns:d="http://docbook.org/ns/docbook"><span xmlns="http://www.w3.org/1999/xhtml" class="author">By <span class="firstname">Douglas</span> <span class="surname">Wright</span></span></div></div></div><p>
The new Media Kit has been discussed several times in the last few issues
of the Newsletter, in articles covering topics that range from timing to
playing sounds. This information is intended to help developers
understand the Media Kit and how to use it in applications. As with any
new API, it takes a while to figure out how to use the Media Kit
effectively, and how to document the tips and tricks you learn so that
everyone can use them.
</p><p>
The Media Kit's breadth, depth, and flexibility make it powerful and
subtle. Its primary component—the <code class="classname">BMediaNode</code>—is the embodiment of
its power and flexibility. These same qualities, however, can make node
writing a more than trivial activity. That's why we've been refining the
nodes that ship with the system, such as the mixer and the sound card
node. And now it's time to introduce some of those refinements to our
developers.
</p><p>
I've prepared a totally bare Audio Producer node as sample code. It's
designed to synthesize data; it doesn't implement the file interface, but
you can add that as needed. I've also included a sample implementation
that generates a square wave; you can start with the empty
implementation. It uses the new <code class="classname">BTimedEventQueue</code>
and <code class="classname">EndPoint</code> classes to
keep track of events, buffers, and connections. You'll find the sample
code archive here:
</p><p>
ftp://ftp.be.com/pub/samples/media_kit/audioproducernode.zip
</p><p>
The code for a node is too large to present here in its entirety, but
I'll give you the most important parts: the <code class="methodname">Run()</code> loop and the
<code class="methodname">HandleEvent()</code> function. Together they are in complete control of how the
node handles its responsibilities at the correct time.
</p><p>
They demonstrate the preferred use of the
<code class="classname">BTimedEventQueue</code> in a producer, so even a slacker can
be on time. <code class="classname">BTimedEventQueue</code> generates a buffer of
data in <code class="methodname">SetupBuffer()</code> and sends it when a
<code class="constant">HANDLE_BUFFER</code> event is popped off the queue. The rest
of the code is fully commented and ready for human (or alien) consumption.
</p><p>
How a node should work using these new helper classes will be discussed
in detail this weekend at the BeDC, so I'll see you there!
</p><pre class="programlisting cpp">
<span class="type">void</span>
<code class="classname">BEmptyAudio</code>::<code class="methodname">Run</code>()
{
  <span class="type">status_t</span> <code class="varname">err</code> = <code class="constant">B_OK</code>;
  <code class="varname">schedulingLatency</code> = <code class="function">estimate_max_scheduling_latency</code>();
  <span class="type">bigtime_t</span> <code class="varname">latency</code> = 0;
  <span class="type">bigtime_t</span> <code class="varname">wait_until</code> = <code class="constant">B_INFINITE_TIMEOUT</code>;

  while(!<code class="varname">mTimeToQuit</code>)
  {
    <span class="comment">//setup time</span>
    <code class="varname">latency</code> = <code class="varname">mOutput</code>.<code class="methodname">DownStreamLatency</code>() + <code class="varname">schedulingLatency</code>;
    if (<code class="varname">mEvents</code>.<code class="methodname">HasEvents</code>())
    {
      <code class="varname">wait_until</code> =
        <code class="methodname">TimeSource</code>()-&gt;<code class="methodname">RealTimeFor</code>(<code class="varname">mEvents</code>.<code class="methodname">NextEventTime</code>(),
          <code class="varname">latency</code>);
    }
    else
    {
      <code class="varname">wait_until</code> = <code class="constant">B_INFINITE_TIMEOUT</code>;
    }

    <span class="comment">//wait</span>
    <code class="varname">err</code> = <code class="methodname">WaitForMessages</code>();

    <span class="comment">//handle something</span>
    if (<code class="varname">err</code> == <code class="constant">B_TIMED_OUT</code>)
    {
      <code class="methodname">HandleEvent</code>();
    }
    else if (<code class="varname">err</code> != <code class="constant">B_INTERRUPTED</code>)
    {
      TERROR("Unexpected error:\n %s exiting...",
        <code class="function">strerror</code>(<code class="varname">err</code>));
      return;
    }
  }

}

<span class="type">status_t</span>
<code class="classname">BEmptyAudio</code>::<code class="methodname">WaitForMessages</code>(<span class="type">bigtime_t</span> <code class="parameter">wait_until</code>)
{
  <span class="type">status_t</span> <code class="varname">err</code> = <code class="constant">B_OK</code>;
  <span class="type">int32</span> <code class="varname">code</code> = 0;
  <span class="type">char</span> <code class="varname">message</code>[<code class="constant">B_MEDIA_MESSAGE_SIZE</code>];

  if (<code class="function">system_time</code>() &lt; <code class="parameter">wait_until</code> - <code class="constant">ENOUGH_TIME</code>)
  {
    <code class="varname">err</code> = <code class="function">read_port_etc</code>(<code class="varname">mControlPort</code>, &amp;<code class="varname">code</code>, &amp;<code class="varname">message</code>,
            <code class="constant">B_MEDIA_MESSAGE_SIZE</code>, <code class="constant">B_ABSOLUTE_TIMEOUT</code>,
            <code class="parameter">wait_until</code>);
  }
  else
    <code class="varname">err</code> = <code class="constant">B_TIMED_OUT</code>;

  if (<code class="varname">err</code> &gt;= 0)
    <code class="methodname">HandleMessage</code>(<code class="varname">code</code>, &amp;<code class="varname">message</code>, <code class="varname">err</code>);
  else
    return <code class="varname">err</code>;
}

<span class="type">void</span>
<code class="classname">BEmptyAudio</code>::<code class="methodname">HandleEvent</code>()
{
  if (!<code class="varname">mEvents</code>.<code class="methodname">HasEvents</code>())
    return;

  <span class="type">bigtime_t</span> <code class="varname">time</code> = 0;
  <span class="type">int32</span> <code class="varname">what</code> = <code class="classname">BTimedEventQueue</code>::<code class="constant">B_NO_EVENT</code>;
  <span class="type">void *</span><code class="varname">pointer</code> = <code class="constant">NULL</code>;
  <span class="type">uint32</span> <code class="varname">flags</code> = <code class="classname">BTimedEventQueue</code>::<code class="constant">B_NO_CLEANUP</code>;
  <span class="type">int64</span> <code class="varname">data</code> = 0;

  <span class="type">status_t</span> <code class="varname">err</code> =
    <code class="varname">mEvents</code>.<code class="methodname">PopEvent</code>(&amp;<code class="varname">time</code>, &amp;<code class="varname">what</code>, &amp;<code class="varname">pointer</code>, &amp;<code class="varname">flags</code>, &amp;<code class="varname">data</code>);
  if (<code class="varname">err</code>)
   Recycle();
      else
      {
        <code class="methodname">SendBuffer</code>((<span class="type"><code class="classname">BBuffer</code> *</span>)<code class="varname">pointer</code>, <code class="varname">mOutput</code>.<code class="methodname">Destination</code>());
        <code class="varname">mNextTime</code> = <code class="varname">mStartTime</code> +
          (<span class="type">bigtime_t</span>)<code class="function">floor</code>((<code class="varname">mFrameTotal</code> + <code class="varname">mMixFrameCount</code>) *
          1000000.0 /
          (<span class="type">double</span>)<code class="varname">mOutput</code>.<code class="methodname">Format</code>().<code class="varname">u</code>.<code class="varname">raw_audio</code>.<code class="varname">frame_rate</code>);
        <code class="methodname">SetupBuffer</code>(&amp;<code class="varname">mOutput</code>);
      }
      break;
    case <code class="classname">BTimedEventQueue</code>::<code class="constant">B_DATA_STATUS</code>:
      <span class="comment">/* nothing */</span>
      break;
    case <code class="classname">BTimedEventQueue</code>::<code class="constant">B_NO_EVENT</code>:
    default:
      return;
  }
}
</pre></div><hr class="pagebreak" /><div class="sect1"><div xmlns="" xmlns:d="http://docbook.org/ns/docbook" class="titlepage"><div><div xmlns:d="http://docbook.org/ns/docbook"><h2 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="Gassee4-14"></a>The 10,000 Mark</h2></div><div xmlns:d="http://docbook.org/ns/docbook"><span xmlns="http://www.w3.org/1999/xhtml" class="author">By <span class="firstname">Jean-Louis</span> <span class="surname">Gassée</span></span></div></div></div><p>
The title refers, of course, to this week's announcement that we reached
10,000 registered BeOS developers worldwide, not to the "other" 10,000
mark you may have heard about concerning the Dow-Jones average. As we
prepare for the 1999 Be Developer Conference at the end of this week,
we're happy to reach this milestone in achieving a "network effect"
around the BeOS.
</p><p>
But as milestones go, how material is this one in the rational world?
Many have asked the same question regarding the Dow. In the physical
world, in the numbers sphere, there isn't a special role for a specific
number; it doesn't matter if the
<acronym class="acronym" title="Dow Jones Industrial Average">DJIA</acronym>
is at 9,999 or 10,001. Well, yes
and no. For an investment portfolio, the difference is hardly material.
But one assumption is wrong. That is, this isn't a mechanical world, but
a human world of emotions, expectations, and self-fulfilling prophecies.
</p><p>
A symbolic milestone is just that—a symbol of something else. In the
case of the stock market, it adds to existing investor confidence—or
dizziness. For us in the Be community, having 10,000 BeOS developers
worldwide doesn't symbolize reaching dizzying heights, but the number
does add to our confidence that we're joined in the adventure by creative
programmers who share our vision of the future of an area of computing.
We appreciate the vote of confidence—and we're committed to doing our
best to be deserving of it.
</p><p>
When discussing numbers of BeOS developers, we're often asked which
developers are really important—a legitimate but loaded question. It
assumes that some developers are more important than others. This is
true, but we only know which ones after the fact. Reading the history of
a platform engenders the great "It Depends" insight. In some cases,
already successful developers know how to move to a new platform
unencumbered by their past achievements; in other cases new entrants
misread the field and either don't see what the new platform does best or
misunderstand what users really want.
</p><p>
Our view is not to second-guess developers, but to help each and every
one in the best way our knowledge and means allow. This doesn't say that
we shouldn't have opinions, just that we ought to remember what happens
to them and, as much as humanly possible, maintain a balance between
having faith in ourselves and faith in others.
</p></div></div><div id="footer"><hr /><div id="footerT">Prev: <a href="Issue4-13.html">Issue 4-13, March 31, 1999</a>  Up: <a href="volume4.html">Volume 4: 1999</a>  Next: <a href="Issue4-15.html">Issue 4-15, April 14, 1999</a> </div><div id="footerB"><div id="footerBL"><a href="Issue4-13.html" title="Issue 4-13, March 31, 1999"><img src="./images/navigation/prev.png" alt="Prev" /></a> <a href="volume4.html" title="Volume 4: 1999"><img src="./images/navigation/up.png" alt="Up" /></a> <a href="Issue4-15.html" title="Issue 4-15, April 14, 1999"><img src="./images/navigation/next.png" alt="Next" /></a></div><div id="footerBR"><div><a href="http://www.haiku-os.org"><img src="./images/People_24.png" alt="haiku-os.org" title="Visit The Haiku Website" /></a></div><div class="navighome" title="Home"><a accesskey="h" href="index.html"><img src="./images/navigation/home.png" alt="Home" /></a></div></div><div id="footerBC"><a href="http://www.access-company.com/home.html" title="ACCESS Co."><img alt="Access Company" src="./images/access_logo.png" /></a></div></div></div><div id="licenseFooter"><div id="licenseFooterBL"><a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/" title="Creative Commons License"><img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by-nc-nd/3.0/88x31.png" /></a></div><div id="licenseFooterBR"><a href="./LegalNotice.html">Legal Notice</a></div><div id="licenseFooterBC"><span id="licenseText">This work is licensed under a
          <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative
          Commons Attribution-Non commercial-No Derivative Works 3.0 License</a>.</span></div></div></body></html>
